<!DOCTYPE html>
<html>
<head>
    <title>发布计划-当前计划</title>
    #parse("sys/header.html")
    <style>
        body {
            padding-top: 50px;
        }
    </style>
</head>
<body>
<div id="app" v-cloak>
    <nav id="inner_navbar" class="navbar-inverse navbar-fixed-top">
        <div class="navbar">
            <section class="content-header">
                <ol class="breadcrumb" style="position:static;float:none;">
                    <li class="active"><i class="fa fa-home"
                                          style="font-size:20px;position:relative;top:2px;left:-3px;"></i> &nbsp;发布计划
                    </li>
                    <li class="active">当前计划</li>
                </ol>
            </section>
        </div>
    </nav>

    <div class="wrapper">
        <div>
            <div class="wrapper queryPanel">
                <form class="form-horizontal">
                    <div class="col-sm-6">
                        <div class="form-group">
                            <label class="col-sm-2 control-label">发布计划</label>
                            <div class="col-sm-10">
                                <select class="form-control" v-model="currentPlanId">
                                    <option v-for="plan in deployPlanList" :value="plan.name">{{plan.text}}</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label">部署方式</label>
                            <div class="col-sm-10">
                                <select v-if="deployPlan.onlyManual != true" class="form-control" v-model="deployPlan.deployType">
                                    <option value="auto">按照部署方案自动执行</option>
                                    <option value="manual">人工操作执行部署步骤</option>
                                </select>
                                <select v-if="deployPlan.onlyManual == true" class="form-control" v-model="deployPlan.deployType">
                                    <option value="manual">人工操作执行部署步骤</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6">
                        <div class="form-group">
                            <label class="col-sm-2 control-label">计划发布时间</label>
                            <div class="col-sm-10">
                                <p class="form-inline" style="margin-bottom: 0;">
                                    <input type="text" v-model="deployPlan.deployTime" class="form-control" onClick="WdatePicker({dateFmt:'yyyy-MM-dd HH:mm:00'})" id="deployTime" name="deployTime" placeholder="计划发布时间">
                                    <img id="deployTimeIcon" onClick="WdatePicker({el:'deployTime',dateFmt:'yyyy-MM-dd HH:mm:00'})" src="${rc.contextPath}/statics/plugins/My97DatePicker/skin/datePicker.gif" width="16" height="22" align="absmiddle" style="cursor:pointer" />
                                </p>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="desc" class="col-sm-2 control-label">发布计划简述</label>
                            <div class="col-sm-10">
                                <input type="text" class="form-control" v-model="deployPlan.desc" id="desc" name="desc" placeholder="发布计划简述">
                            </div>
                        </div>
                    </div>
                    <div v-if="showAddReleaseInfo" class="col-sm-12">
                        <p style="margin-bottom: 10px;text-align: center"><a style="float: right" data-toggle="modal" @click="showReleaseInfoList" class="btn btn-primary">添加上线项目</a></p>
                    </div>
                </form>
            </div>

            <div class="col-sm-12" style="padding: 10px;">
                <div class="form-inline">
                    <div class="form-group">
                        <label class="control-label">上线项目</label>
                    </div>
                    <div class="form-group">
                        <div v-for="releaseId in deployPlan.releaseIdList" class="btn-group" style="padding-left: 10px;" role="group" aria-label="Basic example">
                            <button type="button" class="btn btn-success">{{releaseId}}</button>
                            <button type="button" class="btn btn-success" @click="removeReleaseId(releaseId)">
                                <span class="glyphicon glyphicon-remove"></span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div style="margin-bottom: 10px;" >
                <table id="planTb" class="table table-bordered">
                    <thead>
                    <tr>
                        <th>部署顺序</th>
                        <th>部署项</th>
                        <th>类型</th>
                        <th>提交人</th>
                        <th>上线项目</th>
                        <th style="width: 250px;">部署设置</th>
                        <th>计划发布时间</th>
                        <th>状态</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr v-bind:class="{'appNotRelated-style': deployItemInfo.appNotRelated}" v-for="(deployItemInfo,index) in deployPlan.deployItemInfoList" data-html="true" data-toggle="tooltip" data-placement="top" v-bind:title="deployItemInfo.appNotRelated?'没有将该应用添加到所属系统或者该应用已下线，无法执行保存操作':''">
                        <td>
                            <input type="text" :disabled="deployItemInfo.deployItemType == 'cr'" required style="width:20px;" v-on:blur="deployOrderChange" @keyup.enter="deployOrderChange" v-model="deployItemInfo.deployOrder">
                        </td>
                        <td><a data-toggle="modal" @click="showDeployItemDetail(deployItemInfo)">{{deployItemInfo.deployItemName}}</a></td>
                        <td>{{deployItemInfo.deployItemType}}</td>
                        <td>{{deployItemInfo.createName}}</td>
                        <td>{{deployItemInfo.releaseId}}</td>
                        <!-- <td><a data-toggle="modal" @click="showReleaseIdDetail">{{deployItemInfo.releaseId}}</a></td> -->
                        <td>
                            <select disabled v-if="(deployItemInfo.deployItemType == 'app' ||
                                            deployItemInfo.deployItemType == 'mq' ||
                                            deployItemInfo.deployItemType == 'ck-argv' ) &&
                                            deployPlan.deployType == 'auto'" v-model="deployItemInfo.deploySetting">
                                <option value="auto">自动部署</option>
                            </select>
                            <select v-if="(deployItemInfo.deployItemType == 'app' ||
                                            deployItemInfo.deployItemType == 'mq' ||
                                            deployItemInfo.deployItemType == 'ck-argv') &&
                                            deployPlan.deployType == 'manual'" v-model="deployItemInfo.deploySetting">
                                <option value="manual">手动部署</option>
                                <option value="soc">SOC部署</option>
                            </select>
                            <select disabled v-if="deployItemInfo.deployItemType == 'ck-ds' ||
                                                    deployItemInfo.deployItemType == 'ck-file' ||
                                                    deployItemInfo.deployItemType == 'ck-other'" v-model="deployItemInfo.deploySetting">
                                <option value="soc">SOC部署</option>
                            </select>
                            <select disabled v-if="deployItemInfo.deployItemType == 'cr'" v-model="deployItemInfo.deploySetting">
                                <option value="dba">DBA部署</option>
                            </select>
                        </td>
                        <td>{{deployItemInfo.deployPlanTime}}</td>
                        <td>{{config.auditState[deployPlan.state]}}</td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <div class="col-sm-12">
                <p v-if="deployPlan.planCanSave" style="margin-bottom: 10px;text-align: center"><a @click="saveDeployPlan" class="btn btn-primary">保存计划</a></p>
            </div>
        </div>
    </div>

    <!--部署项详情-->
    <div>
        <div class="modal fade" id="deployItemDetailModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog" style="width: 1000px;height: 50%;min-height: 600px;">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                            &times;
                        </button>
                        <h4 class="modal-title" id="myModalLabel">
                            上线部署项
                        </h4>
                    </div>
                    <div class="modal-body">
                            <table id="deployItemDetailTab" class="table table-bordered" >
                                <thead>
                                <tr>
                                    <th>部署项名称</th>
                                    <th>关联应用</th>
                                    <th>类型</th>
                                    <th>提交人</th>
                                    <th>提交时间</th>
                                    <th>计划发布时间</th>
                                    <th>备注</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr v-for="(detail,index) in deployItemDetailList">
                                    <td>{{detail.deployItemName}}</a></td>
                                    <td>{{detail.projectName}}</td>
                                    <td>{{detail.deployItemType}}</td>
                                    <td>{{detail.createName}}</td>
                                    <td>{{detail.createTime}}</td>
                                    <td>{{detail.deployPlanTime}}</td>
                                    <td>{{detail.deployMemo}}</td>
                                </tr>
                                </tbody>
                            </table>

                            <div v-if="deployItemDetailModel.content !=''">

                                <p><b>部署内容：</b></p>

                                <pre  style="white-space: pre-wrap;word-wrap: break-word;">{{deployItemDetailModel.content}}</pre>

                            </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!--部署项详情-->
    <div>
        <div class="modal fade" id="deployItemDetailNoListModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog" style="width: 800px;height: 50%;min-height: 600px;">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                            &times;
                        </button>
                        <h4 class="modal-title" id="myModalLabel">
                            上线部署项
                        </h4>
                    </div>
                    <div class="modal-body">
                        <table class="table table-striped table-bordered">
                            <tr>
                                <td style="width:15%"><b>部署项名称</b></td>
                                <td style="width:85%">{{deployItemDetailModel.deployItemName}}</td>
                            </tr>
                            <tr>
                                <td><b>类型</b></td>
                                <td>{{deployItemDetailModel.deployItemType}}</td>
                            </tr>
                            <tr>
                                <td><b>提交人</b></td>
                                <td>{{deployItemDetailModel.createName}}</td>
                            </tr>
                            <tr>
                                <td><b>提交时间</b></td>
                                <td>{{deployItemDetailModel.createTime}}</td>
                            </tr>
                            <tr>
                                <td><b>计划发布时间</b></td>
                                <td>{{deployItemDetailModel.deployPlanTime}}</td>
                            </tr>
                            <tr>
                                <td><b>备注</b></td>
                                <td>{{deployItemDetailModel.deployMemo}}</td>
                            </tr>
                        </table>

                        <div v-if="deployItemDetailModel.deployItemType=='cr' && deployItemDetailModel.content !=''">
                                <p><b>部署内容：</b></p>
                                <pre  style="white-space: pre-wrap;word-wrap: break-word;">{{deployItemDetailModel.content}}</pre>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>
    

    <!--上线项目详情-->
    <div>
        <div class="modal fade" id="releaseIdDetail" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog" style="width: 1000px;height: 50%;min-height: 600px;">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                            &times;
                        </button>
                        <h4 class="modal-title">
                            上线项目：《项目编号》
                        </h4>
                    </div>
                    <div class="modal-body">
                        研发留守：刘XX，赵XX
                        测试留守：李XX，张XX

                        《需求描述信息》
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!--选择上线项目-->
    <div>
        <div class="modal fade" id="releaseInfoList" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog" style="width: 800px;">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                            &times;
                        </button>
                        <h4 class="modal-title">
                            请选择上线项目
                        </h4>
                    </div>
                    <div class="modal-body">
                        <p>
                        <form class="form-inline">
                            <div class="form-group">
                                <label for="queryReleaseId">上线项目</label>
                                <input type="text" class="form-control" @keyup.enter="queryReleaseInfoList" id="queryReleaseId" name="queryReleaseId" placeholder="上线项目">
                            </div>
                            <div class="form-group">
                                <label for="queryDesc">需求描述</label>
                                <input type="text" class="form-control" @keyup.enter="queryReleaseInfoList" id="queryDesc" name="queryDesc" placeholder="需求描述">
                            </div>
                            <a data-toggle="modal" @click="queryReleaseInfoList" class="btn btn-default">搜索</a>
                        </form>
                        </p>
                        <table id="jqGrid"></table>
                        <div id="jqGridPager"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" @click="selectReleaseInfoList" class="btn btn-primary">选择</button>
                        <button type="button" id="selectModal" class="btn btn-default" data-dismiss="modal">关闭</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    function showPlanDetail(planId) {
        loading();
        $.ajax({
            url: "${rc.contextPath}/deployPlan/queryAllDeployPlan",
            type: "get",
            success: function(response) {
                var planList = response.list;
                vm.deployPlanList = [
                    {name: 'newPlan', text: '新建发布计划'}
                ];
                for (var index in planList) {
                    if (planList[index].state == 'not_audited' ||
                        planList[index].state == 'audit_success' ||
                        planList[index].state == 'audit_failed') {
                        var plan = {name: planList[index].planId, text: planList[index].planId + '(' + vm.config.auditState[planList[index].state] + ')'};
                        vm.deployPlanList.push(plan);
                    }
                }
                vm.currentPlanId = planId;
                if (vm.currentPlanId == 'newPlan' && vm.deployPlanList.length > 0) {
                    vm.currentPlanId = vm.deployPlanList[1].name;
                }
                if (vm.currentPlanId != 'newPlan') {
                    $.ajax({
                        url: "${rc.contextPath}/deployPlan/queryOneDeployPlan",
                        type: "get",
                        data: {planId: vm.currentPlanId},
                        success: function(response) {
                            vm.deployPlan = response.plan;
                            checkPlanCanSave();
                            layer.closeAll('loading');
                        }
                    });
                }
            }
        });
    }

    function checkPlanCanSave() {
        vm.deployPlan.planCanSave = true;
        var itemList = vm.deployPlan.deployItemInfoList;
        for (var i = 0; i < itemList.length; i++) {
            if (itemList[i].appNotRelated) {
                vm.deployPlan.planCanSave = false;
                return;
            }
        }
    }

    var vm = new Vue({
        el:'#app',
        data: {
            deployPlan: {
                releaseIdList: [],
                deployItemInfoList: [],
                deployItemInfoHideList: [],
                deployType: 'auto',
                state: 'not_audited'
            },
            config: config,
            showAddReleaseInfo: true,
            currentPlanId: 'newPlan',
            deployPlanList: [
                {name: 'newPlan', text: '新建发布计划'}
            ],
            deployItemDetailList: [],
            deployItemDetailModel: {}
        },
        watch: {
            "deployPlan.deployType": function () {
                vm.resetAutoDeployItem();
            },
            "currentPlanId": function(val, oldVal) {
                loading();
                var planId = vm.currentPlanId;
                if (planId != 'newPlan') {
                    $.ajax({
                        url: "${rc.contextPath}/deployPlan/queryOneDeployPlan",
                        type: "get",
                        data: {planId: planId},
                        success: function(response) {
                            vm.deployPlan = response.plan;
                            checkPlanCanSave();
                            layer.closeAll('loading');
                            vm.$nextTick(function(){
                                $('[data-toggle="tooltip"]').tooltip();
                            });
                        }
                    });
                } else {
                    vm.deployPlan = {
                        releaseIdList: [],
                        deployItemInfoList: [],
                        deployItemInfoHideList: [],
                        deployType: 'auto',
                        state: 'not_audited'
                    };
                    layer.closeAll('loading');
                }
            }
        },
        created: function () {
            showPlanDetail('newPlan');
        },
        methods: {
            showReleaseInfoList: function () {
                $("#queryReleaseId").val("");
                $("#queryDesc").val("");

                vm.queryReleaseInfoList();

                $('#releaseInfoList').modal({
                    keyboard: true
                })
            },
            queryReleaseInfoList: function () {
                // var page = $("#jqGrid").jqGrid('getGridParam','page');

                $("#jqGrid").trigger("reloadGrid");
                // $("#jqGrid").jqGrid('setGridParam',{'width':'700'}).trigger("reloadGrid");
                $("#jqGrid").setGridWidth(700);
            },
            resetAutoDeployItem: function () {
                var itemList = vm.deployPlan.deployItemInfoList;

                for (var i = 0; i < itemList.length; i++) {
                    if (vm.deployPlan.deployType == 'manual' &&
                        (itemList[i].deployItemType == 'app' ||
                        itemList[i].deployItemType == 'ck-argv' ||
                        itemList[i].deployItemType == 'mq')) {
                        itemList[i].deploySetting = 'manual';
                    }
                    if (vm.deployPlan.deployType == 'auto' &&
                        (itemList[i].deployItemType == 'app' ||
                        itemList[i].deployItemType == 'ck-argv' ||
                        itemList[i].deployItemType == 'mq')) {
                        itemList[i].deploySetting = 'auto';
                    }
                    if (itemList[i].deployItemType == 'ck-ds' ||
                        itemList[i].deployItemType == 'ck-file' ||
                        itemList[i].deployItemType == 'ck-other') {
                        itemList[i].deploySetting = 'soc';
                    }
                    if (itemList[i].deployItemType == 'cr') {
                        itemList[i].deploySetting = 'dba';
                    }
                }
            },
            selectReleaseInfoList: function () {
                vm.deployPlan.deployTime = $("#deployTime").val();
                var releaseIdList = getSelectedRows();

                if (releaseIdList != null) {
                    vm.deployPlan.releaseIdList = vm.deployPlan.releaseIdList.concat(releaseIdList);

                    $.ajax({
                        url: "${rc.contextPath}/deployPlan/queryDeployItemInfoForReleaseIdList",
                        type: "post",
                        contentType: "application/x-www-form-urlencoded; charset=utf-8",
                        data: {releaseIdList: releaseIdList},
                        success: function(response) {
                            var minDeployPlanTime = "";
                            $("#selectModal").click();
                            for (var i in response.list) {
                                debugger;
                                // 遍历已有列表，查看是否有相同的
                                // 如果有相同deployItemName的，创建一个新的合并对象，并增加一个字段标识merge_flag
                                var merge_obj = null;
                                for(var j in vm.deployPlan.deployItemInfoList){
                                    var h_deployItemName = vm.deployPlan.deployItemInfoList[j].deployItemName;
                                    if(h_deployItemName && h_deployItemName == response.list[i].deployItemName){
                                        if(vm.deployPlan.deployItemInfoList[j].merge_flag){
                                            // 该对象已经是合并后的对象了
                                            vm.deployPlan.deployItemInfoHideList.push(response.list[i]);
                                        }else{
                                            vm.deployPlan.deployItemInfoHideList.push(response.list[i]);
                                            vm.deployPlan.deployItemInfoHideList.push(vm.deployPlan.deployItemInfoList[j]);
                                        }
                                        merge_obj = vm.deployPlan.deployItemInfoList[j];
                                        merge_obj.merge_flag = true;
                                        if(merge_obj.releaseId != response.list[i].releaseId){
                                            merge_obj.releaseId += ('<br/>'+response.list[i].releaseId);
                                        }
                                        vm.deployPlan.deployItemInfoList[j] = merge_obj;
                                        break;
                                    }
                                }
                                if(merge_obj == null){
                                    vm.deployPlan.deployItemInfoList.push(response.list[i]);
                                }
                                if(minDeployPlanTime == ''){
                                    if(response.list[i].deployPlanTime){
                                        minDeployPlanTime = response.list[i].deployPlanTime;
                                    }
                                } else {
                                    if(response.list[i].deployPlanTime){
                                        if(response.list[i].deployPlanTime < minDeployPlanTime){
                                            minDeployPlanTime = response.list[i].deployPlanTime;
                                        }
                                    }
                                }
                            }
                            if(minDeployPlanTime != ''){
                                // 2017-07-05 09:43:00
                                vm.deployPlan.deployTime = minDeployPlanTime.substring(0,minDeployPlanTime.length-2)+"00";
                            }
                            vm.reSortItemList();
                            vm.setPlanDeployType();
                            vm.resetAutoDeployItem();
                            checkPlanCanSave();
                            vm.$nextTick(function(){
                                $('[data-toggle="tooltip"]').tooltip();
                            });
                            
                        }
                    });
                }
            },
            showDeployItemDetail: function (obj) {
                var id_param = null;
                if(obj){
                    id_param = obj.releaseId;
                }
                if(id_param == null){
                    return ;
                }
                var deployItemName = obj.deployItemName;
                var deployItemType = obj.deployItemType;
                $('#jqGridDeployItemDetail').jqGrid('clearGridData');

                var postData = {
                    releaseId:id_param,
                    deployItemName:deployItemName,
                    deployItemType:deployItemType
                };

                $.ajax({
                    url: "${rc.contextPath}/deployPlan/getDeployInfoList",
                    type: "get",
                    contentType: "application/x-www-form-urlencoded; charset=utf-8",
                    data: {releaseId:id_param,deployItemName:deployItemName,deployItemType:deployItemType},
                    success: function(response) {
                        vm.deployItemDetailList = [];
                        vm.deployItemDetailModel = {};
                        for (var i in response.list) {
                            vm.deployItemDetailList.push(response.list[i]);
                        }
                         
                        if(deployItemType == 'app' || deployItemType == 'cr'){
                            if(vm.deployItemDetailList.length > 0){
                                vm.deployItemDetailModel = vm.deployItemDetailList[0];
                            }else{
                                alert("系统异常，获取数据失败");
                            }
                            vm.deployItemDetailModel.content = response.content;
                            $('#deployItemDetailNoListModal').modal('show');             
                        } else {
                            vm.deployItemDetailModel.content = response.content;
                            $('#deployItemDetailModal').modal('show');
                        }
                    }
                });

            },
            showReleaseIdDetail: function () {

            },
            reSortItemList: function () {
                var itemList = vm.deployPlan.deployItemInfoList;
                var sortedItemList = [];
                var appList = [];
                var crList = [];
                var otherList = [];

                for (var i = 0; i < itemList.length; i++) {
                    if (itemList[i].deployItemType == 'app') {
                        appList.push(itemList[i]);
                    } else if (itemList[i].deployItemType == 'cr') {
                        crList.push(itemList[i]);
                    } else {
                        otherList.push(itemList[i]);
                    }
                }

                appList = vm.sortByTimeAsc(appList);
                crList = vm.sortByTimeAsc(crList);
                otherList = vm.sortByTimeAsc(otherList);

                sortedItemList = sortedItemList.concat(crList, otherList, appList);

                for (var i = 0; i < sortedItemList.length; i++) {
                    sortedItemList[i]['deployOrder'] = i + 1;
                }

                vm.deployPlan.deployItemInfoList = sortedItemList;
            },
            sortByTimeAsc: function (itemList) {
                return _.sortBy(itemList, function (item) {
                    return item.deployPlanTime;
                });
            },
            saveDeployPlan: function () {
                vm.deployPlan.deployTime = $("#deployTime").val();

                if (vm.deployPlan.deployTime == null || vm.deployPlan.deployTime == "") {
                    alert("请填写计划发布时间");
                    return;
                }

                if (vm.deployPlan.releaseIdList.length == 0) {
                    alert("请添加上线项目");
                    return;
                }

                var isPlanTimeValid = false;
                for (var i = 0; i < vm.deployPlan.deployItemInfoList.length; i++) {
                    var item = vm.deployPlan.deployItemInfoList[i];
                    if (item.deployOrder == '') {
                        alert("请输入部署顺序");
                        return;
                    }
                    if (!(item.deployOrder % 1 === 0)) {
                        alert("部署顺序请输入数字");
                        return;
                    }
                    if (vm.deployPlan.deployTime > item.deployPlanTime) {
                        isPlanTimeValid = true;
                    }
                }

                if (isPlanTimeValid) {
                    alert("计划发布时间不能大于部署项发布时间中最小的时间！", function () {
                        $("#deployTimeIcon").click();
                    });
                    return;
                }

                layer.confirm('确认要进行该操作？', {
                    btn: ['确认','取消']
                }, function(){
                    $.ajax({
                        url: "${rc.contextPath}/deployPlan/saveDeployPlan",
                        type: "post",
                        contentType: "application/json; charset=utf-8",
                        data: JSON.stringify(vm.deployPlan),
                        success: function(response) {
                            showPlanDetail(response.data);
                            layer.msg('操作完成', {icon: 1});
                        }
                    });
                }, function(){
                });
            },
            removeReleaseId: function(releaseId) {
                layer.confirm('确认要删除该上线项目吗？', {
                    btn: ['确认','取消']
                }, function(){
                    vm.deployPlan.releaseIdList = _.reject(vm.deployPlan.releaseIdList, function(item) {
                        return item == releaseId;
                    });
                    vm.deployPlan.deployItemInfoList = _.reject(vm.deployPlan.deployItemInfoList, function (item) {
                        return item.releaseId == releaseId;
                    });
                    vm.reSortItemList();
                    vm.setPlanDeployType();
                    vm.resetAutoDeployItem();
                    checkPlanCanSave();

                    if (vm.deployPlan.releaseIdList.length == 0) {
                        vm.deployPlan.deployType = 'auto';
                    }
                    layer.msg('操作完成', {icon: 1});
                });
            },
            setPlanDeployType: function () {
                var itemList = vm.deployPlan.deployItemInfoList;
                vm.deployPlan.deployType = 'auto';
                vm.deployPlan.onlyManual = false;

                for (var i = 0; i < itemList.length; i++) {
                    if (itemList[i].deployItemType == 'ck-ds' ||
                        itemList[i].deployItemType == 'ck-file' ||
                        itemList[i].deployItemType == 'ck-other') {
                        vm.deployPlan.deployType = 'manual';
                        vm.deployPlan.onlyManual = true;
                        break;
                    }
                }
            },
            deployOrderChange: function () {
                vm.deployPlan.deployItemInfoList = _.sortBy(vm.deployPlan.deployItemInfoList, function (item) {
                    return parseInt(item.deployOrder);
                });
            }
        }
    });

    $("#jqGrid").jqGrid({
        url: '${rc.contextPath}/deployPlan/queryNotBindedReleaseInfo',
        datatype: "json",
        colModel: [
            { label: '上线项目', name: 'releaseId', width: 300, key: true},
            { label: '需求描述', name: 'releaseName', width: 300}
        ],
        ajaxGridOptions: {cache: false},
        viewrecords: true,
        height: 200,
        width: 700,
        rowNum: 10,
        rowList : [10,30,50],
        rownumbers: true,
        rownumWidth: 25,
        autowidth:true,
        multiselect: true,
        pager: "#jqGridPager",
        jsonReader : {
            root: "page.list",
            page: "page.currPage",
            total: "page.totalPage",
            records: "page.totalCount"
        },
        prmNames : {
            page:"page",
            rows:"limit",
            order: "order"
        },
        postData: {
            'bindedReleaseIdList': function() {
                return vm.$data.deployPlan.releaseIdList;
            },
            'releaseId': function() {
                return $("#queryReleaseId").val();
            },
            'desc': function () {
                return $("#queryDesc").val();
            }
        },
        gridComplete:function(){
            //隐藏grid底部滚动条
            $("#jqGrid").closest(".ui-jqgrid-bdiv").css({ "overflow-x" : "hidden" });
        }
    });
</script>
</body>
</html>
